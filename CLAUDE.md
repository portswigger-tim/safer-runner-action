# CLAUDE.md - Developer Guide for Safer Runner Action

This guide helps developers understand, maintain, and extend the Safer Runner Action codebase.

## üèóÔ∏è Architecture Overview

### Core Components

```
src/
‚îú‚îÄ‚îÄ pre.ts           # Pre-action hook - establishes analyze mode monitoring
‚îú‚îÄ‚îÄ main.ts          # Main action entry point - applies user configuration
‚îú‚îÄ‚îÄ post.ts          # Post-action analysis and reporting
‚îú‚îÄ‚îÄ setup.ts         # Shared setup functions (DNS, firewall, ipsets)
‚îú‚îÄ‚îÄ validation.ts    # System integrity validation with SHA256 checksums
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ dns-config-builder.ts  # DNSmasq configuration generation
‚îú‚îÄ‚îÄ parsers/
‚îÇ   ‚îú‚îÄ‚îÄ dns-parser.ts          # Parse DNS logs from dedicated files
‚îÇ   ‚îú‚îÄ‚îÄ network-parser.ts      # Parse iptables logs from syslog
‚îÇ   ‚îî‚îÄ‚îÄ github-parser.ts       # GitHub domain management
‚îî‚îÄ‚îÄ formatters/
    ‚îî‚îÄ‚îÄ report-formatter.ts    # Job summary generation
```

### Build Process

```bash
npm run build        # Builds main.ts -> dist/main.js
npm run build:pre    # Builds pre.ts -> dist/pre.js
npm run build:post   # Builds post.ts -> dist/post.js
npm run package      # Clean + build all + run tests (recommended)
npm test             # Run Jest tests only
```

**Critical**: Always run `npm run package` and commit `dist/*.js` files - GitHub Actions executes the compiled versions, not the TypeScript source.

### Three-Phase Action Lifecycle

1. **Pre-hook** (`pre.ts`) - Runs BEFORE main action
   - Establishes analyze mode monitoring
   - Logs DNS to `/tmp/pre-dns.log`
   - Logs iptables to syslog with `Pre-` prefix
   - Saves DNS user info for main action to reuse

2. **Main action** (`main.ts`) - User's specified step
   - Reuses infrastructure from pre-hook (if available)
   - Applies user configuration (analyze/enforce mode)
   - Logs DNS to `/tmp/main-dns.log`
   - Logs iptables to syslog (no prefix)
   - Captures security baseline for validation

3. **Post-action** (`post.ts`) - Runs AFTER workflow completes
   - Parses pre-hook and main logs separately
   - Validates system integrity
   - Generates comprehensive job summary

## üõ°Ô∏è Security Architecture

### Two-Layer Protection Model

1. **DNS Layer (DNSmasq)** - `setup.ts:setupDNSMasq()`
   - Blocks domain resolution for unauthorized domains
   - Returns `NXDOMAIN` for blocked domains in enforce mode
   - Uses Quad9 (9.9.9.9) for allowed domains
   - **Logs to dedicated files**: `/tmp/pre-dns.log` and `/tmp/main-dns.log`
   - Configuration generated by `config/dns-config-builder.ts`

2. **Network Layer (iptables)** - `setup.ts:setupFirewallRules()`
   - Blocks connections to unauthorized IP addresses
   - Uses `ipset` for efficient IP allowlists (github, user)
   - Logs all connection attempts to syslog
   - Log prefixes: `Pre-` for pre-hook, none for main action

### Validation System - `validation.ts`

**Purpose**: Detects tampering with security configurations during workflow execution

**Flow**:
1. **Post-setup baseline** - Capture checksums after security setup complete
2. **User workflow runs** - Potentially malicious code could execute
3. **Post-action verification** - Compare current state to baseline

**Monitored Files**:
- `/etc/dnsmasq.conf` - DNS filtering rules
- `/etc/resolv.conf` - DNS resolver configuration
- `/etc/systemd/resolved.conf.d/no-stub.conf` - systemd DNS config
- `iptables` chains (INPUT, OUTPUT, FORWARD) - Firewall rules

## üìä Logging & Reporting

### Separate Log Files for Pre-hook and Main Action

**DNS Logs** (DNSmasq with `log-facility`):
- Pre-hook: `/tmp/pre-dns.log`
- Main action: `/tmp/main-dns.log`
- Parsed by `parsers/dns-parser.ts`

**Network Logs** (iptables):
- All logged to syslog with iptables log prefixes
- Pre-hook prefix: `Pre-GitHub-Allow:`, `Pre-User-Allow:`, `Pre-Allow-Analyze:`
- Main action prefix: `GitHub-Allow:`, `User-Allow:`, `Drop-Enforce:`, `Allow-Analyze:`
- Parsed by `parsers/network-parser.ts`

### Post-Action Summary Generation

The `post.ts` generates a comprehensive job summary with:

1. **Network Connection Details** - All iptables connections
2. **DNS Information** - All DNS resolutions with CNAME chains
3. **Pre-Hook Security Analysis** (collapsible) - Shows what was monitored before user workflow
4. **System Integrity Report** - Validation results from `validation.ts`
5. **Configuration Advice** - Suggested `allowed-domains` for enforce mode (analyze mode only)

**Key Formatters** (`formatters/report-formatter.ts`):
- `generateNetworkConnectionDetails()` - Formats iptables connections
- `generateDnsTable()` - Creates DNS resolution table with CNAME chains
- `generateDnsDetails()` - Separates GitHub and user DNS activity
- `generateConfigurationAdvice()` - Generates YAML config suggestions

## üîß Development Workflows

### Making Changes

1. **Modify source** - Edit `src/*.ts` files
2. **Build & test** - `npm run package`
3. **Test locally** - Use validation test: `node src/validation.test.ts`
4. **Commit source + dist** - Always commit both `.ts` and `.js` files
5. **Push changes** - Use `GIT_SSH_COMMAND="ssh -o IdentitiesOnly=yes" git push` to avoid SSH agent certificate issues
6. **Test in GitHub Actions** - Use the test workflow

### Adding New Security Features

1. **DNS filtering** - Modify `config/dns-config-builder.ts`
   - Add domains to `getGitHubRequiredDomains()` in `parsers/github-parser.ts`
   - Risky subdomains in `RISKY_GITHUB_SUBDOMAINS` constant

2. **Firewall rules** - Modify `setupFirewallRules()` in `setup.ts`
   - Add ipset rules for new domain categories

3. **Validation** - Add new files/rules to `validation.ts`
   - Update `criticalFiles` array for file monitoring

4. **Reporting** - Enhance formatters in `formatters/report-formatter.ts`
   - Domain purpose inference, status formatting, etc.

5. **Log parsing** - Modify parsers in `parsers/` directory
   - DNS parser for DNSmasq logs
   - Network parser for iptables logs

### Debugging

#### Local Testing
```bash
# Test validation system
node lib/validation.test.ts

# Check TypeScript compilation
npx tsc --noEmit

# Build and check file sizes
npm run package
ls -la dist/
```

#### GitHub Actions Debugging

**DNS Logs**:
```bash
# View pre-hook DNS activity (readable by runner group)
cat /tmp/pre-dns.log

# View main action DNS activity (readable by runner group)
cat /tmp/main-dns.log

# Test DNS resolution
dig @127.0.0.1 example.com
```

**Network Logs**:
```bash
# View iptables logs (all traffic)
sudo grep -E 'Pre-|GitHub-Allow:|User-Allow:|Drop-Enforce:|Allow-Analyze:' /var/log/syslog

# View only pre-hook traffic
sudo grep 'Pre-' /var/log/syslog

# View only main action traffic
sudo grep -E 'GitHub-Allow:|User-Allow:|Drop-Enforce:|Allow-Analyze:' /var/log/syslog | grep -v 'Pre-'
```

**Firewall Status**:
```bash
# Check iptables rules
sudo iptables -L OUTPUT -n --line-numbers

# Check ipsets (GitHub and user allowed IPs)
sudo ipset list github
sudo ipset list user
```

## üß™ Testing Strategy

### Automated Tests - `.github/workflows/test.yml`

1. **test-analyze-mode** - Network monitoring without blocking
2. **test-enforce-mode** - Active threat blocking
3. **test-github-actions-compatibility** - GitHub Actions integration
4. **test-edge-cases** - DNS resolution, localhost, direct IPs
5. **test-system-integrity** - Validation system with Falco integration

### Manual Testing Scenarios

```bash
# Test DNS blocking
timeout 5 curl https://malicious-domain.com  # Should fail in enforce mode

# Test allowed domains
curl https://api.github.com/user  # Should always work

# Test validation tampering
echo "# TEST" | sudo tee -a /etc/dnsmasq.conf  # Should be detected
```

## üö® Security Considerations

### Limitations & Workarounds

The README documents potential attack vectors:
1. **Data exfiltration via allowed domains** - Abuse GitHub/npm for data theft
2. **DNS tunneling** - Encode data in DNS queries
3. **Local file system attacks** - Stage data for later exfiltration
4. **Process/system call abuse** - Container escapes, privilege escalation

### Defense in Depth

Network filtering is **first line of defense**. Recommended complementary tools:
- **Falco** - Runtime security monitoring
- **Container security** - Distroless images, read-only filesystems
- **Dependency scanning** - Snyk, Dependabot
- **SIEM integration** - Log forwarding and analysis

## üìù Common Tasks

### Update GitHub Required Domains

**File**: `src/parsers/github-parser.ts`
```typescript
export function getGitHubRequiredDomains(): string[] {
  return [
    'github.com',
    'actions.githubusercontent.com',
    'api.github.com',
    // Add new domain here
    'new.github.domain.com'
  ];
}
```

**Testing**: Add corresponding test in `github-parser.test.ts`

### Add New Domain Purpose Recognition

**File**: `src/formatters/report-formatter.ts` (within `generateDnsDetails()`)
```typescript
function inferDomainPurpose(domain: string): string {
  if (domain.includes('api.')) return 'üîó API Service';
  // Add new pattern here
  if (domain.includes('webhook.')) return 'üîî Webhook Service';
  return 'üåê External Service';
}
```

### Change DNS Log File Locations

**Files**: `src/pre.ts` and `src/main.ts`
```typescript
// In pre.ts
await setupDNSMasq('analyze', '', false, dnsUser.username, '/tmp/pre-dns.log');

// In main.ts
await setupDNSMasq(mode, allowedDomains, blockRiskySubdomains, dnsUser.username, '/tmp/main-dns.log');
```

**Also update**: `src/post.ts` to read from the new locations

### Enhance Validation

**File**: `validation.ts:44-48`
```typescript
const criticalFiles = [
  '/etc/dnsmasq.conf',
  '/etc/resolv.conf',
  // Add new file to monitor
  '/etc/new-security-file.conf'
];
```

## üìö Key Dependencies

**Production**:
- `@actions/core` - GitHub Actions runtime (inputs, outputs, logging)
- `@actions/exec` - Command execution (sudo, iptables, dnsmasq)

**Development**:
- `typescript` - TypeScript compiler
- `@vercel/ncc` - Bundles TypeScript into single JS file
- `jest` - Testing framework
- `ts-jest` - TypeScript support for Jest

**Node.js Built-ins**:
- `crypto` - SHA256 checksums for validation
- `fs` - File system operations (reading logs, config files)

## üêõ Troubleshooting

### Build Issues
- Ensure TypeScript compiles: `npx tsc --noEmit`
- Check for missing dependencies: `npm install`
- Verify file paths are absolute in imports

### Runtime Issues

**DNS Not Working**:
- Check `/etc/resolv.conf` points to `127.0.0.1`
- Check DNSmasq is running: `sudo systemctl status dnsmasq`
- Check DNS logs: `cat /tmp/main-dns.log` or `cat /tmp/pre-dns.log`
- Test DNS resolution: `dig @127.0.0.1 github.com`

**Connections Blocked Unexpectedly**:
- Check ipsets: `sudo ipset list github` and `sudo ipset list user`
- Check iptables rules: `sudo iptables -L OUTPUT -n --line-numbers`
- Check syslog for blocks: `sudo grep 'Drop-Enforce:' /var/log/syslog`

**Validation Failures**:
- Check if monitored files exist: `/etc/dnsmasq.conf`, `/etc/resolv.conf`
- Check baseline file: `cat /tmp/safer-runner-validation-state.json`
- Check file permissions (must be readable by action)

**Pre-hook Not Running**:
- Check if DNS user state exists: Look for `dns-user` in action state
- Check pre-hook logs in job output
- Verify `dist/pre.js` is committed and up-to-date

### Integration Issues

**Summary Not Showing**:
- Verify `dist/post.js` is updated and committed
- Check post-action logs for errors
- Verify log files exist: `/tmp/main-dns.log`, `/tmp/pre-dns.log`

**GitHub Actions Failing**:
- Check `action.yml` syntax (pre, main, post must all reference correct files)
- Verify all three dist files exist: `dist/pre.js`, `dist/main.js`, `dist/post.js`
- Check for TypeScript compilation errors: `npx tsc --noEmit`

**Log Files Empty or Missing**:
- Check DNSmasq configuration: `sudo cat /etc/dnsmasq.conf` (should have `log-facility=...`)
- Check DNSmasq is running: `sudo systemctl status dnsmasq`
- Check file permissions on `/tmp/` (should be writable)

## üèóÔ∏è Architecture Decisions

### Why Separate DNS Log Files?

Previously, DNS logs went to syslog mixed with iptables logs. We now use dedicated files:
- **Pre-hook**: `/tmp/pre-dns.log` via `log-facility` directive
- **Main action**: `/tmp/main-dns.log` via `log-facility` directive

**Benefits**:
‚úÖ Clear separation between pre-hook and main action DNS activity
‚úÖ Easier parsing (no grep filtering needed)
‚úÖ Better performance (avoid parsing entire syslog)
‚úÖ Consistent with iptables (which uses log prefixes)
‚úÖ Readable by runner group (no sudo required for log access)

### Why Three-Phase Lifecycle (pre/main/post)?

**Pre-hook** establishes monitoring before ANY workflow steps run, including other actions' pre-hooks that run after this action. This provides maximum visibility into network activity.

**Main action** applies user configuration and can skip infrastructure setup if pre-hook succeeded, making it faster and more reliable.

**Post-action** runs after workflow completes and can analyze all logs together, generating a comprehensive security report.

### Why ipset Instead of Individual iptables Rules?

`ipset` provides O(1) lookup for IP addresses vs O(n) for individual iptables rules. With dozens of GitHub domains (each resolving to multiple IPs), this prevents performance degradation as more IPs are allowed.

---

## üí° Pro Tips

1. **Always test both modes** - Analyze and enforce behave differently
2. **Use `npm run package`** - Builds all three JS files and runs tests
3. **Watch file sizes** - Dist files ~900-1000KB each is normal
4. **Check log files first** - `/tmp/pre-dns.log` and `/tmp/main-dns.log` are your friends
5. **Test pre-hook separately** - Add debug logging to verify it runs first
6. **Update tests when changing parsers** - DNS and network parsers have comprehensive test coverage
7. **Verify dist files are committed** - GitHub Actions won't see your changes otherwise
8. **Read job summaries** - Post-action generates detailed security reports
9. **Test edge cases** - Direct IPs, localhost, CNAME chains, multiple IPs per domain
10. **Document changes** - Update this file when making significant modifications

## üîç Code Quality

**Test Coverage**: 169 tests across 6 test suites
- `config/dns-config-builder.test.ts` - 45 tests
- `parsers/dns-parser.test.ts` - 26 tests
- `parsers/network-parser.test.ts` - 19 tests
- `parsers/github-parser.test.ts` - 18 tests
- `formatters/report-formatter.test.ts` - 61 tests
- `validation.test.ts` - 20 tests

**Run tests**: `npm test` (uses Jest)
**Run specific test**: `npm test -- dns-parser.test.ts`
**Watch mode**: `npm test -- --watch`

## üìû Getting Help

- **GitHub Issues** - Bug reports and feature requests
- **Code Review** - Use test workflow to validate changes
- **Documentation** - README.md for user-facing docs
- **Security** - Follow responsible disclosure for security issues

Remember: This action protects against supply chain attacks. Changes should be thoroughly tested and reviewed for security implications.